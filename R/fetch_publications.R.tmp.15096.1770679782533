# Fetch publications from OpenAlex API for Joshua M. McCrain
# Uses openalexR package with tidyverse data processing

library(openalexR)
library(tidyverse)
library(glue)

# Function to format author lists
format_authors <- function(author_data) {
  tryCatch({
    if (is.null(author_data)) return("")

    # Handle different possible structures
    if (is.data.frame(author_data)) {
      if ("au_display_name" %in% names(author_data)) {
        authors <- author_data$au_display_name
      } else if ("display_name" %in% names(author_data)) {
        authors <- author_data$display_name
      } else {
        return("")
      }
    } else if (is.list(author_data)) {
      authors <- sapply(author_data, function(x) {
        if (is.list(x) && "au_display_name" %in% names(x)) {
          x$au_display_name
        } else if (is.list(x) && "display_name" %in% names(x)) {
          x$display_name
        } else {
          ""
        }
      })
    } else {
      return("")
    }

    authors <- authors[authors != ""]
    if (length(authors) == 0) return("")
    if (length(authors) == 1) return(authors[1])
    if (length(authors) == 2) return(paste(authors, collapse = " and "))

    paste(
      paste(authors[-length(authors)], collapse = ", "),
      "and",
      authors[length(authors)]
    )
  }, error = function(e) {
    return("")
  })
}

# Function to reconstruct abstract from inverted index
reconstruct_abstract <- function(inverted_index) {
  if (is.null(inverted_index) || length(inverted_index) == 0) return(NA_character_)

  tryCatch({
    # Create word-position pairs
    word_positions <- map2_dfr(names(inverted_index), inverted_index,
                                ~tibble(word = .x, position = .y)) %>%
      unnest(position) %>%
      arrange(position)

    # Reconstruct abstract
    paste(word_positions$word, collapse = " ")
  }, error = function(e) {
    NA_character_
  })
}

# Main function to fetch McCrain's publications
fetch_mccrain_pubs <- function(author_id = "A5048491430", author_name = "Joshua M. McCrain") {

  message("Fetching publications from OpenAlex...")
  message(glue("Using OpenAlex author ID: {author_id}"))

  # Step 1: Find author ID if not provided
  if (is.null(author_id)) {
    message("Searching for author ID...")

    # Try direct search first
    author_search <- oa_fetch(
      entity = "authors",
      display_name.search = author_name,
      verbose = TRUE
    )

    if (is.null(author_search) || nrow(author_search) == 0) {
      message("Direct search failed. Trying alternative search...")
      # Try without middle initial
      author_search <- oa_fetch(
        entity = "authors",
        display_name.search = "Joshua McCrain",
        verbose = TRUE
      )
    }

    if (is.null(author_search) || nrow(author_search) == 0) {
      stop("Could not find author. OpenAlex API may require an API key. Please visit https://openalex.org/settings/api to register.")
    }

    # Filter for University of Utah affiliation if possible
    if ("affiliation_display_name" %in% names(author_search)) {
      author_match <- author_search %>%
        filter(str_detect(tolower(affiliation_display_name), "utah")) %>%
        slice(1)

      if (nrow(author_match) == 0) {
        message("No Utah affiliation found, using first match...")
        author_match <- author_search %>% slice(1)
      }
    } else {
      author_match <- author_search %>% slice(1)
    }

    author_id <- author_match$id
    message(glue("Found author: {author_match$display_name}"))
    message(glue("OpenAlex ID: {author_id}"))
  }

  # Step 2: Fetch publications
  message("Fetching works...")
  works <- oa_fetch(
    entity = "works",
    author.id = author_id,
    verbose = FALSE
  )

  message(glue("Retrieved {nrow(works)} publications"))

  # Step 3: Process with tidyverse
  pubs <- works %>%
    mutate(
      # Extract and format key fields
      title = str_trim(display_name),
      year = publication_year,
      date = as.character(publication_date),
      journal = if ("so" %in% names(.)) so else NA_character_,
      pub_type = type,
      citations = if (!is.null(cited_by_count)) cited_by_count else 0,

      # Format authors
      authors_formatted = map_chr(author, format_authors),

      # Reconstruct abstract from inverted index (if available)
      abstract_text = if ("abstract_inverted_index" %in% names(.)) {
        map_chr(abstract_inverted_index, reconstruct_abstract)
      } else {
        NA_character_
      },

      # Format citation text
      citation_text = case_when(
        citations == 0 ~ "No citations yet",
        citations == 1 ~ "1 citation",
        TRUE ~ glue("{citations} citations")
      ),

      # Create DOI link
      doi_link = if_else(!is.na(doi), glue("https://doi.org/{doi}"), NA_character_),

      # Clean publication type
      type_clean = str_replace_all(pub_type, "-", " ") %>% str_to_title()
    ) %>%
    select(
      id, title, year, date, any_of(c("journal")), pub_type, type_clean,
      authors_formatted, abstract_text, doi, doi_link,
      citations, citation_text, any_of(c("is_oa")), any_of(c("url"))
    ) %>%
    arrange(desc(year), desc(date))

  return(pubs)
}

# Main execution function
main <- function() {
  # Fetch publications
  pubs <- fetch_mccrain_pubs()

  # Save for caching
  saveRDS(pubs, "data/publications.rds")

  # Also save as CSV for inspection
  write_csv(pubs %>% select(-abstract_text), "data/publications.csv")

  message(glue("\nSuccessfully saved {nrow(pubs)} publications to data/publications.rds"))

  # Print summary
  message("\nPublications by year:")
  pubs %>%
    count(year) %>%
    arrange(desc(year)) %>%
    print()

  return(pubs)
}

# Run if executed as script
if (!interactive()) {
  main()
}
